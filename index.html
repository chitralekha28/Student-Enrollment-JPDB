<!DOCTYPE html>
<html>
<head>
    <title>Student Enrollment Form - JPDB</title>
    <meta charset="utf-8">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

    <script src="https://login2explore.com/jpdb/resources/js/0.0.3/jpdb-commons.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

</head>

<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow p-4">
        <h3 class="text-center mb-3">Student Enrollment Form</h3>

        <form id="studentForm" autocomplete="off">

            <div class="mb-3">
                <label class="form-label">Roll No (Primary Key) <span class="text-danger">*</span></label>
                <input type="text" id="roll" class="form-control" required> 
            </div>

            <div class="mb-3">
                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                <input type="text" id="fullname" class="form-control" required> 
            </div>

            <div class="mb-3">
                <label class="form-label">Class <span class="text-danger">*</span></label>
                <input type="text" id="studentClass" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Birth Date <span class="text-danger">*</span></label>
                <input type="date" id="dob" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Address <span class="text-danger">*</span></label>
                <input type="text" id="address" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Enrollment Date <span class="text-danger">*</span></label>
                <input type="date" id="enrollDate" class="form-control" required>
            </div>

            <div class="text-center mt-4">
                <button type="button" id="saveBtn" class="btn btn-success" disabled>Save</button>
                <button type="button" id="updateBtn" class="btn btn-primary" disabled>Update</button>
                <button type="button" id="resetBtn" class="btn btn-danger" disabled>Reset</button>
            </div>

        </form>
    </div>
</div>

<script>
$(document).ready(function () {
    // CONFIG
    const token = "90934880|-31949258692553164|90959667";
    const dbName = "Student-DB";
    const relName = "Student-Rel";
    const baseUrl = "http://api.login2explore.com:5577";

    // App state
    let recordExists = null; // true | false | null
    let lastRecNo = null;

    // Safely parse JSON responses and avoid exceptions when res.data is missing/invalid
    function parseResponseData(res) {
        if (!res || !res.data) return null;
        try { return JSON.parse(res.data); } catch (e) { return null; }
    }

    // --- Utility Functions ---
    function clearDataFields() {
        $("#fullname, #studentClass, #dob, #address, #enrollDate").val('');
    }

    function setInitialState() {
        $("#studentForm")[0].reset();
        clearDataFields();
        $("#roll").prop("disabled", false).focus();
        $("#saveBtn, #updateBtn, #resetBtn").prop("disabled", true);
        recordExists = null;
        lastRecNo = null;
    }

    function validateForm() {
        let roll = $("#roll").val().trim();
        let fullname = $("#fullname").val().trim();
        let studentClass = $("#studentClass").val().trim();
        let dob = $("#dob").val();
        let address = $("#address").val().trim();
        let enrollDate = $("#enrollDate").val();
        if (!roll || !fullname || !studentClass || !dob || !address || !enrollDate) {
            alert("All fields are required. Please fill in all the details.");
            return false;
        }
        return true;
    }

    function setButtonStates(state) {
        // state: true => existing record (enable Update)
        // state: false => no record (enable Save)
        // state: null => unknown/disabled
        recordExists = state;
        if (state === true) {
            $("#saveBtn").prop("disabled", true);
            $("#updateBtn").prop("disabled", false);
        } else if (state === false) {
            $("#saveBtn").prop("disabled", false);
            $("#updateBtn").prop("disabled", true);
        } else {
            $("#saveBtn, #updateBtn").prop("disabled", true);
        }
    }

    // --- Central safe AJAX helper (moved to outer scope so save/update can use it) ---
    function executeSafeRequest(reqString, apiEndPointUrl, success, failure) {
        $.ajax({
            url: baseUrl + apiEndPointUrl,
            method: "POST",
            data: reqString,
            dataType: "text",
            success: function (resultText) {
                try {
                    const json = JSON.parse(resultText);
                    success(json);
                } catch (e) {
                    // non-JSON server response - treat as error but give caller chance to handle
                    console.warn("Non-JSON server response:", resultText);
                    failure({ status: null, responseText: resultText });
                }
            },
            error: function (xhr) {
                try {
                    const json = JSON.parse(xhr.responseText);
                    failure(json);
                } catch (e) {
                    failure({ status: xhr.status, responseText: xhr.responseText });
                }
            }
        });
    }

    // --- Initialization ---
    setInitialState();

    // --- Event Handler: Check DB on Roll No input (with debounce) ---
    let rollTimer = null;
    $("#roll").on("input", function () {
        clearTimeout(rollTimer);
        const roll = $("#roll").val().trim();
        console.log("Roll input changed:", roll);

        if (roll.length < 1) {
            setInitialState();
            return;
        }

        $("#resetBtn").prop("disabled", false);

        if ($("#roll").prop("disabled")) return;

        // small debounce so we don't spam API on fast typing
        rollTimer = setTimeout(function () {
            // prepare key (number when purely digits)
            const rollVal = /^\d+$/.test(roll) ? parseInt(roll, 10) : roll;
            const key = { Roll_No: rollVal };
            const req = createGET_BY_KEYRequest(token, dbName, relName, JSON.stringify(key));

            executeSafeRequest(req, "/api/get", function (jsonRes) {
                console.log("GET response:", jsonRes);
                if (jsonRes.status === 200 && jsonRes.data && jsonRes.data.record) {
                     const record = jsonRes.data.record;
                     lastRecNo = jsonRes.data.rec_no;

                    $("#fullname").val(record.Full_Name || "");
                    $("#studentClass").val(record.Class || "");
                    $("#dob").val(record.Birth_Date || "");
                    $("#address").val(record.Address || "");
                    $("#enrollDate").val(record.Enrollment_Date || "");
                    $("#roll").prop("disabled", true);
                    lastRecNo = jsonRes.data.rec_no;
// store rec_no for update
                    setButtonStates(true);
                    $("#resetBtn").prop("disabled", false);
                } else if (jsonRes.status === 400 || jsonRes.status === 404) {
                    // no record found -> allow Save
                    clearDataFields();
                    lastRecNo = jsonRes.data.rec_no;
                    setButtonStates(false);
                    $("#resetBtn").prop("disabled", false);
                } else {
                    // unexpected but treat as "no record" so user can save rather than stuck
                    console.warn("Unexpected GET status, enabling Save:", jsonRes);
                    clearDataFields();
                    lastRecNo = null;
                    setButtonStates(false);
                    $("#resetBtn").prop("disabled", false);
                }
            }, function (err) {
                console.error("GET error:", err);
                // on communication error assume not found so user can still enter data & Save
                clearDataFields();
                lastRecNo = null;
                setButtonStates(false);
                $("#resetBtn").prop("disabled", false);
            });
        }, 350);
    });

    // --- Save ---
    $("#saveBtn").click(function () {
        console.log("Save button clicked");
        if (!validateForm()) return;

        const jsonObj = {
            Roll_No: $("#roll").val().trim(),
            Full_Name: $("#fullname").val().trim(),
            Class: $("#studentClass").val().trim(),
            Birth_Date: $("#dob").val(),
            Address: $("#address").val().trim(),
            Enrollment_Date: $("#enrollDate").val()
        };

        const req = createPUTRequest(token, JSON.stringify(jsonObj), dbName, relName);

        executeSafeRequest(req, "/api/iml", function (jsonRes) {
            if (jsonRes.status === 200) {
                alert("Record Saved Successfully!");
                setInitialState();
            } else {
                alert(`Failed to Save Record. Status: ${jsonRes.status}`);
                console.error("PUT Request Failed:", jsonRes);
            }
        }, function (err) {
            alert("Save failed: see console for details.");
            console.error("PUT Error:", err);
        });
    });

    // --- Update ---
    function getRecNo() {
        const rollVal = /^\d+$/.test($("#roll").val().trim()) ? parseInt($("#roll").val().trim(), 10) : $("#roll").val().trim();
        const key = { Roll_No: rollVal };
        const req = createGET_BY_KEYRequest(token, dbName, relName, JSON.stringify(key));
        return new Promise(function (resolve) {
            executeSafeRequest(req, "/api/get", function (jsonRes) {
                if (jsonRes.status === 200 && jsonRes.data && jsonRes.data.rec_no)
                   resolve(jsonRes.data.rec_no);

            }, function (err) {
                console.error("getRecNo error:", err);
                resolve(null);
            });
        });
    }

    $("#updateBtn").click(async function () {
        console.log("Update button clicked");
        if (!validateForm()) return;

        let recNo = lastRecNo || await getRecNo();
        if (!recNo) {
            alert("Cannot update: Record Number not found. Please re-enter the Roll No.");
            setInitialState();
            return;
        }

        const jsonObj = {
            Roll_No: $("#roll").val().trim(),
            Full_Name: $("#fullname").val().trim(),
            Class: $("#studentClass").val().trim(),
            Birth_Date: $("#dob").val(),
            Address: $("#address").val().trim(),
            Enrollment_Date: $("#enrollDate").val()
        };

        const req = createUPDATERecordRequest(token, JSON.stringify(jsonObj), dbName, relName, recNo);

        executeSafeRequest(req, "/api/iml", function (jsonRes) {
            if (jsonRes.status === 200) {
                alert("Record Updated Successfully!");
                setInitialState();
            } else {
                alert(`Failed to Update Record. Status: ${jsonRes.status}`);
                console.error("UPDATE Request Failed:", jsonRes);
            }
        }, function (err) {
            alert("Update failed: see console for details.");
            console.error("UPDATE Error:", err);
        });
    });

    // --- Reset ---
    $("#resetBtn").click(function () {
        console.log("Reset button clicked");
        setInitialState();
        setButtonStates(null);
    });

});
</script>


</body>
</html>